
{% extends 'base/index.html' %}
{% load static %}

<style>
@media (max-width: 768px) {
  .table td {
    font-size: 0.85rem;
  }
  .carousel-inner {
    max-width: 100px !important;
  }
  .carousel-inner img {
    max-height: 80px !important;
  }
}
</style>

{% block content %}
{% include 'produits/ajout.html' with form=form image_form=image_form %}
{% include 'produits/modifier.html' with form=form image_form=image_form %}
{% include 'produits/supprimer.html' %}

<div class="container mt-4">
    <h2 class="mb-4 text-center fw-bold">üõí Tableau de bord - Produits</h2>

    {% if messages %}
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">{{ message }}</div>
      {% endfor %}
    {% endif %}

    {% if not user.is_superuser %}
      <div class="alert alert-info">Certaines fonctionnalit√©s sont r√©serv√©es √† l‚Äôadministrateur.</div>
    {% endif %}

    <!-- Statistiques -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-white bg-primary shadow">
                <div class="card-body">
                    <h5 class="card-title">Produits</h5>
                    <p class="card-text fs-4">{{ stats.nb_produits }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-success shadow">
                <div class="card-body">
                    <h5 class="card-title">Commandes</h5>
                    <p class="card-text fs-4">{{ stats.nb_commandes }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-warning shadow">
                <div class="card-body">
                    <h5 class="card-title">Utilisateurs</h5>
                    <p class="card-text fs-4">{{ stats.nb_users }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-danger shadow">
                <div class="card-body">
                    <h5 class="card-title">Alertes Stock</h5>
                    <p class="card-text fs-4">{{ stats.nb_alertes }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Barre de recherche -->
    <!-- Barre de recherche -->
<form method="get" class="mb-3 d-flex flex-wrap gap-2">

  <input type="text" name="q" placeholder="üîé Rechercher un produit" class="form-control w-50" value="{{ request.GET.q }}">

  <select name="categorie" class="form-select w-25">
      <option value=""> üìÇToutes cat√©gories</option>
      {% for c in categories %}
      <option value="{{ c.id }}" {% if request.GET.categorie == c.id|stringformat:"s" %}selected{% endif %}>
          {{ c.nom }}
      </option>
      {% endfor %}
  </select>

  <!--  Tri -->
  <select name="tri" class="form-select w-25">
      <option value="">‚ÜïÔ∏è Trier par</option>
      <option value="nom_asc" {% if request.GET.tri == "nom_asc" %}selected{% endif %}>Nom (A ‚Üí Z)</option>
      <option value="nom_desc" {% if request.GET.tri == "nom_desc" %}selected{% endif %}>Nom (Z ‚Üí A)</option>
      <option value="prix_asc" {% if request.GET.tri == "prix_asc" %}selected{% endif %}>Prix (Croissant)</option>
      <option value="prix_desc" {% if request.GET.tri == "prix_desc" %}selected{% endif %}>Prix (D√©croissant)</option>
  </select>

  <!--  Filtre stock -->
  <select name="stock" class="form-select w-25">
      <option value="">üßÆ Stock (Tous)</option>
      <option value="rupture" {% if request.GET.stock == "rupture" %}selected{% endif %}>Rupture (0)</option>
      <option value="faible" {% if request.GET.stock == "faible" %}selected{% endif %}>Faible (< 5)</option>
  </select>

  <button type="submit" class="btn btn-primary">Appliquer</button>

  <!--  Bouton reset -->
  <a href="{% url 'dashboard_admin' %}" class="btn btn-secondary">üîÑR√©initialiser</a>

</form>


      
    <!-- Actions -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="fw-semibold">üì¶ Liste des produits</h4>
        <div>
            {% if user.is_superuser %}
                <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalAjoutProduit">‚ûï Ajouter</button>
            {% endif %}
            <a href="{% url 'export_csv' %}" class="btn btn-outline-dark mx-1">üì§ Export CSV</a>
            <a href="{% url 'export_pdf' %}" class="btn btn-outline-dark">üìÑ Export PDF</a>
        </div>
    </div>

    <!-- Table des produits -->
    <div class="table-responsive shadow">
        <table class="table table-hover table-bordered text-center align-middle">
            <thead class="table-dark">
                <tr>
                    <th>Image</th>
                    <th>Nom</th>
                    <th>Cat√©gorie</th>
                    <th>Prix</th>
                    <th>Stock</th>
                    {% if user.is_superuser %}<th>Actions</th>{% endif %}
                </tr>
            </thead>
            <tbody>
                {% for produit in produits %}
                <tr>
                  <td>
                    {% if produit.images.all %}
                    <div id="carouselProduit{{ produit.id }}" class="carousel slide" data-bs-ride="false">
                      <div class="carousel-inner" style="max-width: 150px; margin: auto;"> <!-- Conteneur fix√© -->
                        {% for image in produit.images.all %}
                        <div class="carousel-item {% if forloop.first %}active{% endif %}">
                          <img src="{{ image.image.url }}" class="d-block mx-auto rounded"
                               style="max-height: 120px; width: auto; max-width: 100%; object-fit: cover;"
                               alt="Image {{ forloop.counter }}">
                        </div>
                        {% endfor %}
                        {% if produit.images.all|length > 1 %}
                        <button class="carousel-control-prev" type="button" data-bs-target="#carouselProduit{{ produit.id }}" data-bs-slide="prev">
                          ‚¨ÖÔ∏è
                        </button>
                        <button class="carousel-control-next" type="button" data-bs-target="#carouselProduit{{ produit.id }}" data-bs-slide="next">
                          ‚û°Ô∏è
                        </button>
                        {% endif %}
                      </div>
                      {% else %}
                        <span class="text-muted">Aucune image</span>
                      {% endif %}
                      </div>
                     
                  </td>
              
                  <td>{{ produit.nom }}</td>
                  <td>{{ produit.categorie.nom }}</td>
                  <td>{{ produit.prix }} FCFA</td>
                  <td>
                    {% if produit.stock <= 5 %}
                        <span class="badge bg-danger">{{ produit.stock }}</span>
                    {% else %}
                        <span class="badge bg-success">{{ produit.stock }}</span>
                    {% endif %}
                </td>
                  
                <td>
                  <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#modalModifierProduit{{ produit.id }}">
                    üìù Modifier
                  </button>
                  {% if user.is_superuser %}
                  <button class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#modalSupprimerProduit{{ produit.id }}">
                    ‚ùå Supprimer
                  </button>
                  {% endif %}
              </td>
                
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <div class="d-flex justify-content-center mt-3">
      <nav>
          <ul class="pagination">
              {% if produits.has_previous %}
                  <li class="page-item"><a class="page-link" href="?page={{ produits.previous_page_number }}">Pr√©c√©dent</a></li>
              {% endif %}
              {% for i in produits.paginator.page_range %}
                  <li class="page-item {% if produits.number == i %}active{% endif %}">
                      <a class="page-link" href="?page={{ i }}">{{ i }}</a>
                  </li>
              {% endfor %}
              {% if produits.has_next %}
                  <li class="page-item"><a class="page-link" href="?page={{ produits.next_page_number }}">Suivant</a></li>
              {% endif %}
          </ul>
      </nav>
  </div>
</div>
{% block scripts %}
{% if request.GET.modifier %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    let modal = new bootstrap.Modal(document.getElementById('modalModifierProduit'));
    modal.show();
  });
</script>
{% endif %}
{% endblock %}
{% endblock %}
